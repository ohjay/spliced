function findPosition(e){if("undefined"!=typeof e.offsetParent){for(var t=0,n=0;e;e=e.offsetParent)t+=e.offsetLeft,n+=e.offsetTop;return[t,n]}return[e.x,e.y]}function createMarker(e,t){var n=document.createElement("img");return n.setAttribute("src",t),n.setAttribute("class","marker"),n.setAttribute("id",e),n}function drawMarkers(e,t,n){n="undefined"==typeof n?!1:n;var o,i,r,a=points[e],s=a.length,l=0;for(i=0;s>i;++i)r=MARKER_DIR+l+MARKER_EXT,l=(l+1)%NUM_MARKERS,o=a[i],document.body.appendChild(createMarker("marker"+currMarkerId,r)),$("#marker"+currMarkerId).css("left",o[0]+t[0]-5).css("top",o[1]+t[1]-5).show(),inv[currMarkerId]=i,++currMarkerId;n&&(markerMagic=currMarkerId)}function removeAllMarkers(e){for(e="undefined"==typeof e?!1:e,e||(markerMagic=0);currMarkerId>markerMagic;){var t=document.getElementById("marker"+--currMarkerId);document.body.removeChild(t)}}function overlay(e,t,n){n="undefined"==typeof n?0:n;var o=$("#"+e),i=document.getElementById(t),r=findPosition(i);o.css("position","absolute"),o.css("left",r[0]+n+"px"),o.css("top",r[1]+n+"px"),o.css("width",i.clientWidth+"px"),o.css("height",i.clientHeight+"px")}function unnormalize(e,t,n){return e.map(function(e){return[e[0]*t,e[1]*n]})}function drawPointsFromFile(e,t,n){n="undefined"==typeof n?!1:n,$.getJSON(t,function(t){img=document.getElementById(e),points[e]=unnormalize(t.points,img.clientWidth,img.clientHeight),drawMarkers(e,findPosition(img),n)})}function getPointsFilepath(e){var t=document.getElementById(e).src,n=t.substring(t.lastIndexOf("/")+1,t.lastIndexOf("."));return SUPPORTED_ANIMALS.indexOf(n)>-1?[POINTS_DIR,n+".min.json"].join("/"):DEFAULT_POINTS_FILEPATH}function getImageData(e){var t=document.createElement("canvas"),n=t.getContext("2d");return t.width=e.clientWidth,t.height=e.clientHeight,n.drawImage(e,0,0,t.width,t.height),n.getImageData(0,0,e.width,e.height)}function fillOutputCanvas(e,t,n,o){t.width=n,t.height=o;var i=t.getContext("2d"),r=i.createImageData(n,o);r.data.set(new Uint8ClampedArray(e)),i.putImageData(r,0,0),t.style.display="block"}function computeAuxPoints(e){var t=[];return t.push([e[0][0],.75*e[0][1]]),t.push([e[3][0],.5*e[0][1]]),t.push([e[4][0],.45*e[0][1]]),t.push([e[5][0],.4*e[0][1]]),t.push([e[33][0],.35*e[0][1]]),t.push([e[33][0],.6*e[0][1]]),t.push([e[9][0],.4*e[0][1]]),t.push([e[10][0],.45*e[0][1]]),t.push([e[11][0],.5*e[0][1]]),t.push([e[14][0],.75*e[0][1]]),t}function constrain(e,t,n){for(var o=0;o<e.length;++o)e[o][0]=e[o][0].clip(0,t-1),e[o][1]=e[o][1].clip(0,n-1);return e}function detectPoints(e,t){var n=document.getElementById(e),o=document.createElement("canvas"),i=o.getContext("2d");o.width=n.clientWidth,o.height=n.clientHeight,i.drawImage(n,0,0,o.width,o.height);var r=new clm.tracker({stopOnConvergence:!0});r.init(pModel);var a={hasConverged:!1},s=function(o){a.hasConverged=!0;var i=r.getCurrentPosition();if(i){for(var l=computeAuxPoints(i),c=i.length;c>=0;--c)-1===CLMTRACKR_KEEP.indexOf(c)&&i.splice(c,1);points[e]=constrain(i.concat(l),n.clientWidth,n.clientHeight),drawMarkers(e,findPosition(n),!0)}else drawPointsFromFile(e,DEFAULT_POINTS_FILEPATH,!0);document.removeEventListener("clmtrackrConverged",s),"undefined"!=typeof t&&null!=t&&t()};document.addEventListener("clmtrackrConverged",s,!1),r.start(o),setTimeout(function(){a.hasConverged||(r.stop(),s())},CLMTRACKR_TIMEOUT)}function doMorph(){var e=parseInt(this.innerText.slice(0,-1));e=MAGNITUDES[e];var t=JSON.parse(JSON.stringify(points)),n=runTriangulation(t,e.shape),o=n[0],i=n[1],r=getImageData(document.getElementById(ID_IMG_FROM)).data,a=getImageData(document.getElementById(ID_IMG_TO)).data,s=document.getElementById(ID_IMG_TO),l=s.clientWidth,c=s.clientHeight,d=document.getElementById(ID_CVS_OUT);$("#"+ID_GO_CONTAINER).css("display","none"),$("#"+ID_LOADER).css("display","inline-block"),setTimeout(function(){var n=computeMidpointImage(o,i,r,a,t[ID_IMG_FROM],t[ID_IMG_TO],l,c,d,e.color0,e.color1),s=null;n?(fillOutputCanvas(n,d,l,c),s=new Custombox.modal({content:{effect:"fadein",target:"#"+ID_OUTPUT_MODAL,onComplete:function(){$("#"+ID_DOWNLOAD).attr("href",d.toDataURL("image/png"))}}})):alert("The Splice was a failure! Please reposition the markers."),$("#"+ID_LOADER).css("display","none"),$("#"+ID_GO_CONTAINER).css("display","block"),null!=s&&(Custombox.modal.closeAll(),s.open())},0)}function touchHandler(e){var t=e.changedTouches[0],n=document.createEvent("MouseEvent");n.initMouseEvent({touchstart:"mousedown",touchmove:"mousemove",touchend:"mouseup"}[e.type],!0,!0,window,1,t.screenX,t.screenY,t.clientX,t.clientY,!1,!1,!1,!1,0,null),t.target.dispatchEvent(n),e.preventDefault()}function setupCanvases(){overlay(ID_CVS_FROM,ID_IMG_FROM,BORDER_SIZE),overlay(ID_CVS_TO,ID_IMG_TO,BORDER_SIZE)}function setupImageUploads(){document.getElementById(ID_UPLOAD).addEventListener("change",function(){var e=document.getElementById(ID_IMG_FROM),t=document.getElementById(ID_UPLOAD).files[0],n=new FileReader;n.onloadend=function(){e.style.display="none",e.src=n.result;var t=document.getElementById(ID_IMG_TO),o=document.getElementById(ID_CONTAINER_FROM);o.style.width=t.clientWidth+"px",o.style.height=t.clientHeight+"px",o.style.marginBottom="13px",cropper=new Cropper(e,{cropBoxResizable:!1,aspectRatio:t.clientWidth/t.clientHeight,ready:function(){this.cropper.setCropBoxData({left:0,top:0,width:t.clientWidth,height:t.clientHeight}),e.style.display="inline"}}),$("#"+ID_UPLOAD_BTN).css("display","none"),$("#"+ID_CONFIRM_CROP_BTN).addClass("gold"),$("#"+ID_CONFIRM_CROP_BTN).css("display","inline-block"),$("#"+ID_CONFIRM_IMG_BTN).addClass("pure-button-disabled"),$("#"+ID_CROP_INSTRS).css("display","inline")},t&&n.readAsDataURL(t)},!0),$("#"+ID_CONFIRM_CROP_BTN).click(function(e){var t=document.getElementById(ID_IMG_TO),n=cropper.getCroppedCanvas({width:t.clientWidth,height:t.clientHeight});cropper.destroy();var o=document.getElementById(ID_IMG_FROM);o.src=n.toDataURL(),$("#"+ID_CONFIRM_CROP_BTN).css("display","none"),$("#"+ID_CONFIRM_CROP_BTN).removeClass("gold"),$("#"+ID_UPLOAD_BTN).css("display","inline-block"),$("#"+ID_CONFIRM_IMG_BTN).removeClass("pure-button-disabled"),$("#"+ID_CROP_INSTRS).css("display","none")})}function setupAnimalSelection(){var e,t,n=document.getElementById(ID_ANIMAL_SELECTION),o=n.getElementsByTagName("img");for(e=0;e<o.length;++e)o[e].classList.contains("animal-active")&&(activeAnimal=o[e]),o[e].onclick=function(){null!=activeAnimal&&$(activeAnimal).removeClass("animal-active"),t=this.src,$("#"+ID_IMG_TO).attr("src",t.replace("_small","")),activeAnimal=this,$(activeAnimal).addClass("animal-active"),currMarkerId>0&&(removeAllMarkers(!0),drawPointsFromFile(ID_IMG_TO,getPointsFilepath(ID_IMG_TO),!1))}}function setupImageSwitching(){$("#"+ID_CHANGE_IMG_BTN).click(function(e){var t,n=document.getElementById(ID_GO_CONTAINER),o=n.getElementsByTagName("button");for(t=0;t<o.length;++t)$(o[t]).addClass("pure-button-disabled");removeAllMarkers(),$("#"+ID_CHANGE_IMG_BTN).css("display","none"),$("#"+ID_CONFIRM_IMG_BTN).css("display","inline-block"),$("#"+ID_UPLOAD_BTN).removeClass("pure-button-disabled")})}function setupImageConfirm(){$("#"+ID_CONFIRM_IMG_BTN).click(function(e){$("#"+ID_UPLOAD_BTN).addClass("pure-button-disabled"),$("#"+ID_CONFIRM_IMG_BTN).css("display","none"),$("#"+ID_CHANGE_IMG_BTN).css("display","inline-block");var t=function(){points[ID_IMG_TO]=[],drawPointsFromFile(ID_IMG_TO,getPointsFilepath(ID_IMG_TO),!1),setupMarkers();var e,t=document.getElementById(ID_GO_CONTAINER),n=t.getElementsByTagName("button");for(e=0;e<n.length;++e)$(n[e]).removeClass("pure-button-disabled")};points[ID_IMG_FROM]=[];var n=document.getElementById(ID_IMG_FROM);n.src.endsWith("chimpanzee.jpg")?(drawPointsFromFile(ID_IMG_FROM,DEFAULT_POINTS_FILEPATH,!0),t()):detectPoints(ID_IMG_FROM,t)})}function setupMarkers(){function e(e){e||(e=window.event);var n=e.target||e.srcElement;if(n.id.startsWith("marker")){var o=relevId==ID_IMG_FROM?ID_CVS_FROM:ID_CVS_TO;relevCtx=document.getElementById(o).getContext("2d");var i=document.getElementById(relevId);return relevWidth=i.clientWidth,relevHeight=i.clientHeight,relevMarkerNo=parseInt(n.id.match(/\d+$/)[0],10),relevPos=findPosition(i),document.addEventListener("mousemove",t),!1}}function t(e){e||(e=window.event);var t=[e.pageX-relevPos[0],e.pageY-relevPos[1]];return t[0]>=0&&t[0]<relevWidth&&t[1]>=0&&t[1]<relevHeight&&($("#marker"+relevMarkerNo).css("left",e.pageX-5).css("top",e.pageY-5),points[relevId][inv[relevMarkerNo]]=t,relevCtx.clearRect(0,0,relevWidth,relevHeight)),!1}function n(e){document.removeEventListener("mousemove",t)}document.onmousedown=e,document.onmouseup=n}function setupExample(){$("#"+ID_EXAMPLE).click(function(e){Custombox.modal.closeAll(),new Custombox.modal({content:{effect:"fadein",target:"#"+ID_EXAMPLE_MODAL}}).open()})}function setupTouchHandler(){document.addEventListener("touchstart",touchHandler,!0),document.addEventListener("touchmove",touchHandler,!0),document.addEventListener("touchend",touchHandler,!0),document.addEventListener("touchcancel",touchHandler,!0)}function setupModalClose(){var e=function(e){return e.preventDefault(),Custombox.modal.close(),!1};$("#"+ID_EXAMPLE_CLOSE).click(e),$("#"+ID_MODAL_CLOSE).click(e)}function setupGoButtons(){for(var e=document.getElementById(ID_GO_CONTAINER),t=e.getElementsByTagName("button"),n=0;n<t.length;++n)t[n].onclick=doMorph}var activeAnimal=null,currMarkerId=0,markerMagic=0,points={},inv={},relevId=ID_IMG_FROM,relevCtx,relevWidth,relevHeight,relevMarkerNo,relevPos,cropper;$(window).on("load",function(){setupCanvases(),setupImageUploads(),setupAnimalSelection(),setupImageSwitching(),setupImageConfirm(),setupExample(),setupTouchHandler(),setupModalClose(),setupGoButtons()});