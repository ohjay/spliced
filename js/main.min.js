function findPosition(e){if(void 0!==e.offsetParent){for(var t=0,n=0;e;e=e.offsetParent)t+=e.offsetLeft,n+=e.offsetTop;return[t,n]}return[e.x,e.y]}function createMarker(e,t){var n=document.createElement("img");return n.setAttribute("src",t),n.setAttribute("class","marker"),n.setAttribute("id",e),n}function drawMarkers(e,t,n,i){n=void 0!==n&&n;var r,o,a,l=points[e],s=l.length,c=0;for(o=0;o<s;++o)a=MARKER_DIR+c+MARKER_EXT,c=(c+1)%NUM_MARKERS,r=l[o],document.body.appendChild(createMarker("marker"+currMarkerId,a)),$("#marker"+currMarkerId).css("left",r[0]+t[0]-5).css("top",r[1]+t[1]-5).show(),inv[currMarkerId]=o,++currMarkerId;n&&(markerMagic=currMarkerId),void 0!==i&&null!==i&&i()}function removeAllMarkers(e){for((e=void 0!==e&&e)||(markerMagic=0);currMarkerId>markerMagic;){var t=document.getElementById("marker"+--currMarkerId);document.body.removeChild(t)}}function overlay(e,t,n){n=void 0===n?0:n;var i=$("#"+e),r=document.getElementById(t),o=findPosition(r);i.css("position","absolute"),i.css("left",o[0]+n+"px"),i.css("top",o[1]+n+"px"),i.css("width",r.clientWidth+"px"),i.css("height",r.clientHeight+"px")}function unnormalize(e,t,n){return e.map(function(e){return[e[0]*t,e[1]*n]})}function drawPointsFromFile(e,t,n,i){n=void 0!==n&&n,$.getJSON(t,function(t){img=document.getElementById(e),points[e]=unnormalize(t.points,img.clientWidth,img.clientHeight),drawMarkers(e,findPosition(img),n),void 0!==i&&null!==i&&i()})}function getPointsFilepath(e){var t=document.getElementById(e).src,n=t.substring(t.lastIndexOf("/")+1,t.lastIndexOf("."));return SUPPORTED_ANIMALS.indexOf(n)>-1?[POINTS_DIR,n+".min.json"].join("/"):DEFAULT_POINTS_FILEPATH}function getImageData(e){var t=document.createElement("canvas"),n=t.getContext("2d");return t.width=e.clientWidth,t.height=e.clientHeight,n.drawImage(e,0,0,t.width,t.height),n.getImageData(0,0,e.width,e.height)}function fillOutputCanvas(e,t,n,i){t.width=n,t.height=i;var r=t.getContext("2d"),o=r.createImageData(n,i);o.data.set(new Uint8ClampedArray(e)),r.putImageData(o,0,0),t.style.display="block"}function computeAuxPoints(e){var t=[];return t.push([e[0][0],.75*e[0][1]]),t.push([e[3][0],.5*e[0][1]]),t.push([e[4][0],.45*e[0][1]]),t.push([e[5][0],.4*e[0][1]]),t.push([e[33][0],.35*e[0][1]]),t.push([e[33][0],.6*e[0][1]]),t.push([e[9][0],.4*e[0][1]]),t.push([e[10][0],.45*e[0][1]]),t.push([e[11][0],.5*e[0][1]]),t.push([e[14][0],.75*e[0][1]]),t}function constrain(e,t,n){for(var i=0;i<e.length;++i)e[i][0]=e[i][0].clip(0,t-1),e[i][1]=e[i][1].clip(0,n-1);return e}function detectPoints(e,t){var n=document.getElementById(e),i=document.createElement("canvas"),r=i.getContext("2d");i.width=n.clientWidth,i.height=n.clientHeight,r.drawImage(n,0,0,i.width,i.height);var o=new clm.tracker({stopOnConvergence:!0});o.init(pModel);var a={hasConverged:!1},l=function(i){a.hasConverged=!0;var r=o.getCurrentPosition();if(r){for(var s=computeAuxPoints(r),c=r.length;c>=0;--c)-1===CLMTRACKR_KEEP.indexOf(c)&&r.splice(c,1);points[e]=constrain(r.concat(s),n.clientWidth,n.clientHeight),drawMarkers(e,findPosition(n),!0,t)}else drawPointsFromFile(e,DEFAULT_POINTS_FILEPATH,!0,t);document.removeEventListener("clmtrackrConverged",l)};document.addEventListener("clmtrackrConverged",l,!1),o.start(i),setTimeout(function(){a.hasConverged||(o.stop(),l())},CLMTRACKR_TIMEOUT)}function doMorph(){var e=parseInt(this.innerText.slice(0,-1));e=MAGNITUDES[e];var t=JSON.parse(JSON.stringify(points)),n=runTriangulation(t,e.shape),i=n[0],r=n[1],o=getImageData(document.getElementById(ID_IMG_FROM)).data,a=getImageData(document.getElementById(ID_IMG_TO)).data,l=document.getElementById(ID_IMG_TO),s=l.clientWidth,c=l.clientHeight,d=document.getElementById(ID_CVS_OUT);$("#"+ID_GO_CONTAINER).css("display","none"),$("#"+ID_LOADER).css("display","inline-block"),setTimeout(function(){var n=computeMidpointImage(i,r,o,a,t[ID_IMG_FROM],t[ID_IMG_TO],s,c,d,e.color0,e.color1),l=null;n?(fillOutputCanvas(n,d,s,c),l=new Custombox.modal({content:{effect:"fadein",target:"#"+ID_OUTPUT_MODAL,onComplete:function(){$("#"+ID_DOWNLOAD).attr("href",d.toDataURL("image/png"))}}})):alert("The Splice was a failure! Please reposition the markers."),$("#"+ID_LOADER).css("display","none"),$("#"+ID_GO_CONTAINER).css("display","block"),null!=l&&(Custombox.modal.closeAll(),l.open())},0)}function setupCanvases(){overlay(ID_CVS_FROM,ID_IMG_FROM,BORDER_SIZE),overlay(ID_CVS_TO,ID_IMG_TO,BORDER_SIZE)}function setupImageUploads(){document.getElementById(ID_UPLOAD).addEventListener("change",function(){var e=document.getElementById(ID_IMG_FROM),t=document.getElementById(ID_UPLOAD).files[0],n=new FileReader;n.onloadend=function(){e.style.display="none",e.src=n.result;var t=document.getElementById(ID_IMG_TO),i=document.getElementById(ID_CONTAINER_FROM);i.style.width=t.clientWidth+"px",i.style.height=t.clientHeight+"px",i.style.marginBottom="13px",cropper=new Cropper(e,{cropBoxResizable:!1,aspectRatio:t.clientWidth/t.clientHeight,ready:function(){this.cropper.setCropBoxData({left:0,top:0,width:t.clientWidth,height:t.clientHeight}),e.style.display="inline"}}),$("#"+ID_UPLOAD_BTN).css("display","none"),$("#"+ID_CONFIRM_CROP_BTN).addClass("gold"),$("#"+ID_CONFIRM_CROP_BTN).css("display","inline-block"),$("#"+ID_CONFIRM_IMG_BTN).addClass("pure-button-disabled"),$("#"+ID_CROP_INSTRS).css("display","inline")},t&&n.readAsDataURL(t)},!0),$("#"+ID_CONFIRM_CROP_BTN).click(function(e){var t=document.getElementById(ID_IMG_TO),n=cropper.getCroppedCanvas({width:t.clientWidth,height:t.clientHeight});cropper.destroy(),document.getElementById(ID_IMG_FROM).src=n.toDataURL(),$("#"+ID_CONFIRM_CROP_BTN).css("display","none"),$("#"+ID_CONFIRM_CROP_BTN).removeClass("gold"),$("#"+ID_UPLOAD_BTN).css("display","inline-block"),$("#"+ID_CONFIRM_IMG_BTN).removeClass("pure-button-disabled"),$("#"+ID_CROP_INSTRS).css("display","none")})}function setupAnimalSelection(){var e,t,n=document.getElementById(ID_ANIMAL_SELECTION).getElementsByTagName("img");for(e=0;e<n.length;++e)n[e].classList.contains("animal-active")&&(activeAnimal=n[e]),n[e].onclick=function(){null!=activeAnimal&&$(activeAnimal).removeClass("animal-active"),t=this.src,$("#"+ID_IMG_TO).attr("src",t.replace("_small","")),activeAnimal=this,$(activeAnimal).addClass("animal-active"),currMarkerId>0&&(removeAllMarkers(!0),drawPointsFromFile(ID_IMG_TO,getPointsFilepath(ID_IMG_TO),!1))}}function setupImageSwitching(){$("#"+ID_CHANGE_IMG_BTN).click(function(e){var t,n=document.getElementById(ID_GO_CONTAINER).getElementsByTagName("button");for(t=0;t<n.length;++t)$(n[t]).addClass("pure-button-disabled");removeAllMarkers(),$("#"+ID_CHANGE_IMG_BTN).css("display","none"),$("#"+ID_CONFIRM_IMG_BTN).css("display","inline-block"),$("#"+ID_UPLOAD_BTN).removeClass("pure-button-disabled"),isMobile&&$("#"+ID_MARKER_INSTRS).css("display","none")})}function setupImageConfirm(){$("#"+ID_CONFIRM_IMG_BTN).click(function(e){$("#"+ID_UPLOAD_BTN).addClass("pure-button-disabled"),$("#"+ID_CONFIRM_IMG_BTN).css("display","none"),$("#"+ID_CHANGE_IMG_BTN).css("display","inline-block");var t=function(){points[ID_IMG_TO]=[],drawPointsFromFile(ID_IMG_TO,getPointsFilepath(ID_IMG_TO),!1),setupMarkers();var e,t=document.getElementById(ID_GO_CONTAINER).getElementsByTagName("button");for(e=0;e<t.length;++e)$(t[e]).removeClass("pure-button-disabled")};points[ID_IMG_FROM]=[],document.getElementById(ID_IMG_FROM).src.endsWith("chimpanzee.jpg")?drawPointsFromFile(ID_IMG_FROM,DEFAULT_POINTS_FILEPATH,!0,t):detectPoints(ID_IMG_FROM,t),isMobile&&$("#"+ID_MARKER_INSTRS).css("display","inline")})}function setupMarkers(){function e(e){e||(e=window.event);var t=e.target||e.srcElement,n=t.id.match(/\d+$/);if(t.id.startsWith("marker")&&null!==n){var i=parseInt(n[0],10);if(!(i>=markerMagic)){var r=relevId==ID_IMG_FROM?ID_CVS_FROM:ID_CVS_TO;relevCtx=document.getElementById(r).getContext("2d");var o=document.getElementById(relevId);return relevWidth=o.clientWidth,relevHeight=o.clientHeight,relevMarkerNo=i,relevPos=findPosition(o),$("#marker"+relevMarkerNo).addClass("glow"),!1}}}function t(e){e||(e=window.event);var t=[e.pageX-relevPos[0],e.pageY-relevPos[1]];return t[0]>=0&&t[0]<relevWidth&&t[1]>=0&&t[1]<relevHeight&&($("#marker"+relevMarkerNo).css("left",e.pageX-5).css("top",e.pageY-5),points[relevId][inv[relevMarkerNo]]=t,relevCtx.clearRect(0,0,relevWidth,relevHeight)),!1}function n(e){$("#marker"+relevMarkerNo).removeClass("glow"),relevMarkerNo=null}document.onmousedown=function(n){var i=e(n);return null!==relevMarkerNo&&document.addEventListener("mousemove",t),i},document.onmouseup=function(e){document.removeEventListener("mousemove",t),n(e)},document.addEventListener("touchend",function(i){var r=i.changedTouches[0];null!==relevMarkerNo?(t(r),n(r),i.preventDefault()):void 0!==e(r)&&i.preventDefault()},!0)}function setupExample(){$("#"+ID_EXAMPLE).click(function(e){Custombox.modal.closeAll(),new Custombox.modal({content:{effect:"fadein",target:"#"+ID_EXAMPLE_MODAL}}).open()})}function setupModalClose(){var e=function(e){return e.preventDefault(),Custombox.modal.close(),!1};$("#"+ID_EXAMPLE_CLOSE).click(e),$("#"+ID_MODAL_CLOSE).click(e)}function setupGoButtons(){for(var e=document.getElementById(ID_GO_CONTAINER).getElementsByTagName("button"),t=0;t<e.length;++t)e[t].onclick=doMorph}var activeAnimal=null,currMarkerId=0,markerMagic=0,points={},inv={},relevId=ID_IMG_FROM,isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),relevCtx,relevWidth,relevHeight,relevMarkerNo=null,relevPos,cropper;$(window).on("load",function(){setupCanvases(),setupImageUploads(),setupAnimalSelection(),setupImageSwitching(),setupImageConfirm(),setupExample(),setupModalClose(),setupGoButtons()});